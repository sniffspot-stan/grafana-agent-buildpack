#!/bin/bash

BUILD_DIR=$1
CACHE_DIR=$2

ENV_DIR=$3

export_env_dir() {
  acceptlist_regex=${2:-'^(PROM_USERNAME|PROM_PASS)$'}
  denylist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$ENV_DIR" ]; then
    for e in $(ls $ENV_DIR); do
      echo "$e" | grep -E "$acceptlist_regex" | grep -qvE "$denylist_regex" &&
      export "$e=$(cat $ENV_DIR/$e)"
      :
    done
  fi
}

export_env_dir();

mkdir -p $BUILD_DIR/bin

echo "Downloading agent binary."
curl -o "$CACHE_DIR/agent.zip" -L "https://github.com/grafana/agent/releases/download/v0.39.0/grafana-agent-linux-amd64.zip"
unzip "$CACHE_DIR/agent.zip" -d $CACHE_DIR
mv "$CACHE_DIR/grafana-agent-linux-amd64" "$BUILD_DIR/bin/grafana-agent"
rm "$CACHE_DIR/agent.zip"

if ! [ -x "$(command -v envsubst)" ]; then
  echo "Installing dependencies."
  apt install -y gettext
fi

echo "Substituting envrionment variables."
envsubst < $BUILD_DIR/grafana-agent.cfg > $BUILD_DIR/grafana-agent.env.cfg